name: Test Plugins

on:
  pull_request:
    paths:
      - 'plugins/**'
  push:
    branches:
      - main
    paths:
      - 'plugins/**'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Make test files executable
        run: |
          chmod +x plugins/test-harness
          chmod +x plugins/*/test.sh

      - name: Run all plugin tests
        env:
          HAMR_TEST_MODE: "1"
        run: |
          cd plugins
          
          # Track results
          total_tests=0
          total_passed=0
          total_failed=0
          failed_plugins=""
          
          # Run each plugin's test.sh
          for test_file in */test.sh; do
            plugin_name=$(dirname "$test_file")
            echo "::group::Testing $plugin_name"
            
            if output=$(./"$test_file" 2>&1); then
              # Extract test counts from output
              if [[ "$output" =~ Tests:\ ([0-9]+)\ \|.*Passed:\ ([0-9]+).*Failed:\ ([0-9]+) ]]; then
                tests="${BASH_REMATCH[1]}"
                passed="${BASH_REMATCH[2]}"
                failed="${BASH_REMATCH[3]}"
                total_tests=$((total_tests + tests))
                total_passed=$((total_passed + passed))
                total_failed=$((total_failed + failed))
              fi
              echo "$output"
              echo "::endgroup::"
            else
              echo "$output"
              echo "::endgroup::"
              echo "::error::Plugin $plugin_name tests failed"
              failed_plugins="$failed_plugins $plugin_name"
              # Still try to extract counts
              if [[ "$output" =~ Tests:\ ([0-9]+)\ \|.*Passed:\ ([0-9]+).*Failed:\ ([0-9]+) ]]; then
                tests="${BASH_REMATCH[1]}"
                passed="${BASH_REMATCH[2]}"
                failed="${BASH_REMATCH[3]}"
                total_tests=$((total_tests + tests))
                total_passed=$((total_passed + passed))
                total_failed=$((total_failed + failed))
              fi
            fi
          done
          
          # Summary
          echo ""
          echo "========================================"
          echo "Total: $total_tests | Passed: $total_passed | Failed: $total_failed"
          echo "========================================"
          
          if [[ -n "$failed_plugins" ]]; then
            echo "::error::Failed plugins:$failed_plugins"
            exit 1
          fi

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-output
          path: plugins/*/test.sh
          retention-days: 7
