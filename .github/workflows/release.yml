# Release Workflow
#
# Before triggering a release, complete the manual steps in:
# docs/releases/checklist.md
#
# This workflow is triggered by:
# - Pushing a tag matching 'v*' (e.g., v0.1.0)
# - Manual dispatch with optional tag input

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.1.0)'
        required: false
        type: string

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

jobs:
  build-linux-x86_64:
    name: Build Linux x86_64
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-4-dev \
            pkg-config \
            meson \
            ninja-build \
            libwayland-dev \
            gobject-introspection \
            libgirepository1.0-dev \
            gtk-doc-tools \
            valac

      - name: Build and install gtk4-layer-shell
        run: |
          git clone https://github.com/wmww/gtk4-layer-shell.git
          cd gtk4-layer-shell
          meson setup build
          ninja -C build
          sudo ninja -C build install
          sudo ldconfig

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binaries
        run: cargo build --release

      - name: Generate plugin checksums
        run: ./scripts/generate-plugin-checksums.sh

      - name: Create archive
        run: |
          mkdir -p dist/hamr-linux-x86_64
          cp target/release/hamr dist/hamr-linux-x86_64/
          cp target/release/hamr-daemon dist/hamr-linux-x86_64/
          cp target/release/hamr-gtk dist/hamr-linux-x86_64/
          cp target/release/hamr-tui dist/hamr-linux-x86_64/
          cp -r plugins dist/hamr-linux-x86_64/
          cp README.md LICENSE dist/hamr-linux-x86_64/ 2>/dev/null || true
          cd dist && tar -czvf hamr-linux-x86_64.tar.gz hamr-linux-x86_64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hamr-linux-x86_64
          path: dist/hamr-linux-x86_64.tar.gz

  release:
    name: Create Release
    needs: [build-linux-x86_64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.tag != ''
    steps:
      - name: Download x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: hamr-linux-x86_64
          path: dist

      - name: Get release tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create checksums
        working-directory: dist
        run: |
          sha256sum hamr-linux-x86_64.tar.gz > checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
           tag_name: ${{ steps.tag.outputs.tag }}
           name: Hamr ${{ steps.tag.outputs.tag }}
           draft: true
           generate_release_notes: true
           files: |
             dist/hamr-linux-x86_64.tar.gz
             dist/checksums.txt

  update-aur:
    name: Update AUR Package
    needs: [build-linux-x86_64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.tag != ''
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get release tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Extract version from tag
        id: version
        run: |
          TAG=${{ steps.tag.outputs.tag }}
          VERSION=${TAG#v}  # Remove 'v' prefix
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION from tag: $TAG"

      - name: Update PKGBUILD version
        run: |
          VERSION=${{ steps.version.outputs.version }}
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" pkg/aur/PKGBUILD
          # Update source line with new version
          sed -i "s/hamr-[0-9.]*::git/hamr-$VERSION::git/" pkg/aur/PKGBUILD
          sed -i "s/#tag=v[0-9.]*/#tag=v$VERSION/" pkg/aur/PKGBUILD
          echo "Updated PKGBUILD pkgver to $VERSION"

      - name: Update .SRCINFO version
        run: |
          VERSION=${{ steps.version.outputs.version }}
          sed -i "s/^\tpkgver = .*/\tpkgver = $VERSION/" pkg/aur/.SRCINFO
          sed -i "s/hamr-[0-9.]*::git/hamr-$VERSION::git/" pkg/aur/.SRCINFO
          sed -i "s/#tag=v[0-9.]*/#tag=v$VERSION/" pkg/aur/.SRCINFO
          echo "Updated .SRCINFO pkgver to $VERSION"

      - name: Update hamr-bin PKGBUILD version
        run: |
          VERSION=${{ steps.version.outputs.version }}
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" pkg/aur-bin/PKGBUILD
          # Update source URLs with new version
          sed -i "s/hamr-bin-[0-9.]*-/hamr-bin-$VERSION-/g" pkg/aur-bin/PKGBUILD
          sed -i "s|/v[0-9.]*/hamr-linux|/v$VERSION/hamr-linux|g" pkg/aur-bin/PKGBUILD
          echo "Updated hamr-bin PKGBUILD pkgver to $VERSION"

      - name: Update hamr-bin .SRCINFO version
        run: |
          VERSION=${{ steps.version.outputs.version }}
          sed -i "s/^\tpkgver = .*/\tpkgver = $VERSION/" pkg/aur-bin/.SRCINFO
          sed -i "s/hamr-bin-[0-9.]*-/hamr-bin-$VERSION-/g" pkg/aur-bin/.SRCINFO
          sed -i "s|/v[0-9.]*/hamr-linux|/v$VERSION/hamr-linux|g" pkg/aur-bin/.SRCINFO
          echo "Updated hamr-bin .SRCINFO pkgver to $VERSION"

      - name: Commit AUR package updates to repo
        run: |
          VERSION=${{ steps.version.outputs.version }}
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add pkg/aur/PKGBUILD pkg/aur/.SRCINFO pkg/aur-bin/PKGBUILD pkg/aur-bin/.SRCINFO
          git commit -m "chore: update AUR packages to v$VERSION" || echo "No changes to commit"
          git push

      - name: Install SSH key for AUR
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$AUR_SSH_KEY" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          cat > ~/.ssh/config << 'EOF'
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

      - name: Publish hamr to AUR
        run: |
          VERSION=${{ steps.version.outputs.version }}
          git clone ssh://aur@aur.archlinux.org/hamr.git aur-repo
          cd aur-repo
          git config user.email "siwei.wong@gmail.com"
          git config user.name "Stewart Wong"
          cp ../pkg/aur/PKGBUILD ../pkg/aur/.SRCINFO ../pkg/aur/hamr.install .
          git add PKGBUILD .SRCINFO hamr.install
          git diff --cached --quiet || git commit -m "Update to v$VERSION"
          git push || echo "AUR push failed - may need manual intervention"

      - name: Publish hamr-bin to AUR
        run: |
          VERSION=${{ steps.version.outputs.version }}
          git clone ssh://aur@aur.archlinux.org/hamr-bin.git aur-bin-repo
          cd aur-bin-repo
          git config user.email "siwei.wong@gmail.com"
          git config user.name "Stewart Wong"
          cp ../pkg/aur-bin/PKGBUILD ../pkg/aur-bin/.SRCINFO ../pkg/aur-bin/hamr.install .
          git add PKGBUILD .SRCINFO hamr.install
          git diff --cached --quiet || git commit -m "Update to v$VERSION"
          git push || echo "AUR hamr-bin push failed - may need manual intervention"
