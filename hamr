#!/bin/bash
set -euo pipefail

# Detect if dev instance is running (started with -p flag)
# If so, use path-based IPC; otherwise use config-based IPC
get_ipc_args() {
    # Check if a qs process is running with -p pointing to a hamr repo
    local dev_path
    dev_path=$(pgrep -af "qs.*-p.*/hamr" 2>/dev/null | grep -v "ipc" | head -1 | sed -n 's/.*-p[[:space:]]*\([^[:space:]]*\).*/\1/p')
    
    if [[ -n "$dev_path" ]]; then
        echo "-p $dev_path"
    else
        echo "-c hamr"
    fi
}

show_help() {
    cat <<HELP
Usage: hamr [OPTIONS] [COMMAND]

Hamr - Extensible launcher for Wayland compositors

Commands:
  (none)              Start hamr daemon (use in autostart)
  toggle              Toggle hamr open/close
  plugin <name>       Open a specific plugin directly
  status <id> <json>  Update plugin status (badges, description)

Options:
  -h, --help          Show this help message

Examples:
  hamr                Start hamr daemon
  hamr toggle         Toggle launcher visibility
  hamr plugin clipboard   Open clipboard plugin
  hamr plugin emoji       Open emoji picker
  hamr status todo '{"badges": [{"text": "5"}]}'

Keybinding examples (Hyprland):
  bind = SUPER, Space, exec, hamr toggle
  bind = SUPER, V, exec, hamr plugin clipboard

Keybinding examples (Niri):
  Mod+Space { spawn "hamr" "toggle"; }
  Mod+V { spawn "hamr" "plugin" "clipboard"; }
HELP
}

case "${1:-}" in
    -h|--help)
        show_help
        exit 0
        ;;
    toggle)
        # shellcheck disable=SC2046
        exec qs ipc $(get_ipc_args) call hamr toggle
        ;;
    plugin)
        if [[ -z "${2:-}" ]]; then
            echo "Error: plugin name required" >&2
            echo "Usage: hamr plugin <name>" >&2
            exit 1
        fi
        # shellcheck disable=SC2046
        exec qs ipc $(get_ipc_args) call hamr plugin "$2"
        ;;
    status)
        if [[ -z "${2:-}" ]] || [[ -z "${3:-}" ]]; then
            echo "Error: plugin ID and JSON required" >&2
            echo "Usage: hamr status <plugin-id> '<json>'" >&2
            echo "Example: hamr status todo '{\"badges\": [{\"text\": \"5\"}]}'" >&2
            exit 1
        fi
        # shellcheck disable=SC2046
        exec qs ipc $(get_ipc_args) call pluginRunner updateStatus "$2" "$3"
        ;;
    "")
        exec qs -c hamr
        ;;
    *)
        echo "Error: unknown command '$1'" >&2
        echo "Run 'hamr --help' for usage" >&2
        exit 1
        ;;
esac
